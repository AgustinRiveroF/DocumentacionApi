<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="/socket.io/socket.io.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="/CSS/style.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">

    <title>Products</title>
</head>

<body>
    <header>
        <div class="headersContent">
            <div class="titleHomeHeader">
                <h1 class="tittleHome"><a class="tittleHome"
                        href="/api/products">Hamburgueseria</a></h1>
            </div>
            <div id="cart-link">
                <p class="totalProducts">{{totalProductsInCart}}</p>
                <a href="/api/carts/my-cart" title="Ver mi carrito">
                    <svg class="cart-log" xmlns="http://www.w3.org/2000/svg" width="40" height="30" fill="currentColor"
                        class="bi bi-cart4" viewBox="0 0 16 16">
                        <path
                            d="M0 2.5A.5.5 0 0 1 .5 2H2a.5.5 0 0 1 .485.379L2.89 4H14.5a.5.5 0 0 1 .485.621l-1.5 6A.5.5 0 0 1 13 11H4a.5.5 0 0 1-.485-.379L1.61 3H.5a.5.5 0 0 1-.5-.5M3.14 5l.5 2H5V5zM6 5v2h2V5zm3 0v2h2V5zm3 0v2h1.36l.5-2zm1.11 3H12v2h.61zM11 8H9v2h2zM8 8H6v2h2zM5 8H3.89l.5 2H5zm0 5a1 1 0 1 0 0 2 1 1 0 0 0 0-2m-2 1a2 2 0 1 1 4 0 2 2 0 0 1-4 0m9-1a1 1 0 1 0 0 2 1 1 0 0 0 0-2m-2 1a2 2 0 1 1 4 0 2 2 0 0 1-4 0" />
                    </svg>
                </a>
            </div>
            <div class="premium-link">
                <a href="/api/users/premium" title="Usuarios Premium">
                    <svg class="premium-log" xmlns="http://www.w3.org/2000/svg" width="40" height="30"
                        fill="currentColor" class="bi bi-lock" viewBox="0 0 16 16">
                        <path
                            d="M8 1a2 2 0 0 1 2 2v4H6V3a2 2 0 0 1 2-2m3 6V3a3 3 0 0 0-6 0v4a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2M5 8h6a1 1 0 0 1 1 1v5a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1V9a1 1 0 0 1 1-1" />
                    </svg>
                </a>
            </div>
            <div class="documents-link" title="Documentos de rol">
                <a href="/views/documents">
                    <svg class="documents-log" xmlns="http://www.w3.org/2000/svg" width="40" height="30"
                        fill="currentColor" class="bi bi-file-earmark-arrow-up-fill" viewBox="0 0 16 16">
                        <path
                            d="M9.293 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V4.707A1 1 0 0 0 13.707 4L10 .293A1 1 0 0 0 9.293 0M9.5 3.5v-2l3 3h-2a1 1 0 0 1-1-1M6.354 9.854a.5.5 0 0 1-.708-.708l2-2a.5.5 0 0 1 .708 0l2 2a.5.5 0 0 1-.708.708L8.5 8.707V12.5a.5.5 0 0 1-1 0V8.707z" />
                    </svg>
                </a>
            </div>
        </div>


    </header>

    <div id="chatContainer" class="minimized">
        <div id="chat">
            <div id="chatHeader">
                <button id="toggleChat"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30"
                        fill="currentColor" class="bi bi-chat-dots" viewBox="0 0 16 16">
                        <path
                            d="M5 8a1 1 0 1 1-2 0 1 1 0 0 1 2 0m4 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0m3 1a1 1 0 1 0 0-2 1 1 0 0 0 0 2" />
                        <path
                            d="m2.165 15.803.02-.004c1.83-.363 2.948-.842 3.468-1.105A9 9 0 0 0 8 15c4.418 0 8-3.134 8-7s-3.582-7-8-7-8 3.134-8 7c0 1.76.743 3.37 1.97 4.6a10.4 10.4 0 0 1-.524 2.318l-.003.011a11 11 0 0 1-.244.637c-.079.186.074.394.273.362a22 22 0 0 0 .693-.125m.8-3.108a1 1 0 0 0-.287-.801C1.618 10.83 1 9.468 1 8c0-3.192 3.004-6 7-6s7 2.808 7 6-3.004 6-7 6a8 8 0 0 1-2.088-.272 1 1 0 0 0-.711.074c-.387.196-1.24.57-2.634.893a11 11 0 0 0 .398-2" />
                    </svg></button>
            </div>
            <div id="chatMessages"></div>
            <div id="chatForm">
                <input type="text" name="message" id="message" placeholder="Envía un mensaje aquí">
                <button type="button" id="botonEnviar">Enviar</button>
            </div>
        </div>
    </div>



    {{#if 'admin'}}
    <div class="admin-menu">
        <input type="checkbox" id="admin-toggle">
        <label for="admin-toggle">&#9776; Panel de Usuario</label>
        <div class="admin-content">
            <div id="infoUser">
                <p>Bienvenido, {{user.first_name}}!</p>
                <h4>Tus datos son:</h4>
                <p>Nombre de Usuario: {{user.first_name}} {{user.last_name}}</p>
                <p>Id de Usuario: {{user.id}}</p>
                {{#if errorMessage}}
                <p style="color: rgb(134, 235, 52);">{{loginMessage}}</p>
                {{/if}}
                <p>Email: {{user.email}}</p>
                <p>Rol: {{user.role}}</p>
            </div>
            <div id="logout">
                <a href="/logout/">Salir</a>
            </div>
        </div>
    </div>

    {{else}}
    <div id="user-section">
        <h2>Panel de Usuario</h2>
    </div>
    {{/if}}

    <div class="products-grid">
        {{#each products}}
        <div class="product-item" data-id="{{this._doc._id}}" data-user-id="{{user.id}}">
            <h3>{{this._doc.product_name}}</h3>
            <p>{{this._doc.product_description}}</p>
            <p>${{this._doc.product_price}}</p>
            <div class="producto" data-product-id="{{this._doc._id}}">
                <img src="/IMG/info.png" alt="info" alt="Producto 1" class="imagen" title="{{this._doc._id}}"
                    data-product-id="{{this._doc._id}}">
            </div>
            <button class="add-to-cart" data-id="{{this._doc._id}}" data-user-id="{{user.id}}">AGREGAR</button>
        </div>
        {{/each}}
    </div>

    <div class="pagination-buttons">
        <button id="prevPage">Anterior</button>
        {{#if hasNextPage}}
        <button id="nextPage">Siguiente</button>
        {{else}}
        <span class="disabled"></span>
        {{/if}}
    </div>

    <p class="totalPages">Página: {{currentPage}} - {{totalPages}}</p>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
        crossorigin="anonymous"></script>
    <script src="/JS/chat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/handlebars@4.7.7/dist/handlebars.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.1.3/socket.io.js"></script>

    <script>

        document.addEventListener('DOMContentLoaded', async () => {
            const addToCartButtons = document.querySelectorAll('.add-to-cart');
            const socket = io.connect('http://localhost:8080/');


            addToCartButtons.forEach(button => {
                button.addEventListener('click', async () => {
                    const productId = button.dataset.id;
                    const cartId = "{{user.cartID}}";
                    const productName = button.closest('.product-item').querySelector('h3').textContent;
                    const productDescription = button.closest('.product-item').querySelector('p:nth-child(2)').textContent;
                    const productPrice = parseFloat(button.closest('.product-item').querySelector('p:nth-child(3)').textContent.replace('$', ''));


                    try {
                        const addToCartResponse = await fetch('/api/carts/' + cartId + '/add-product', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                productId,
                                quantity: 1,
                                product_name: productName,
                                product_description: productDescription,
                                product_price: productPrice
                            })
                        });

                        const data = await addToCartResponse.json();

                        if (data) {
                            const totalProductsInCart = data.cart.products.length;
                            socket.emit("totalProductsUpdated", totalProductsInCart);
                        } else {
                            console.log('Error en la respuesta del servidor:', data);
                        }
                    } catch (error) {
                        console.log('Error al agregar producto al carrito:', error);
                    }
                });
            });


            socket.on('totalProductsUpdated', (totalProducts) => {
                if (totalProducts !== null) {
                    document.querySelector('.totalProducts').textContent = totalProducts;
                }
            });

        });




        document.addEventListener('DOMContentLoaded', function () {
            const adminToggle = document.getElementById('admin-toggle');
            const adminContent = document.querySelector('.admin-content');
            const prevPageBtn = document.getElementById('prevPage');
            const nextPageBtn = document.getElementById('nextPage');

            adminToggle.addEventListener('change', function () {
                adminContent.style.display = adminToggle.checked ? 'block' : 'none';
            });

            if (prevPageBtn) {
                prevPageBtn.addEventListener('click', function () {
                    const currentPage = parseInt("{{page}}");
                    const prevPage = currentPage - 1;
                    if (prevPage > 0) {
                        window.location.href = `/api/products?page=${prevPage}`;
                    }
                });
            }

            if (nextPageBtn) {
                nextPageBtn.addEventListener('click', function () {
                    const currentPage = parseInt("{{page}}");
                    const nextPage = currentPage + 1;
                    window.location.href = `/api/products?page=${nextPage}`;
                });
            }
        });

    </script>


</body>

</html>